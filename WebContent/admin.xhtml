<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:p="http://xmlns.jcp.org/jsf/passthrough">

<h:head>
    <title>IceCreamy: Admin</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
    <link href="#{request.contextPath}/css/mycustom.css" rel="stylesheet" />
    <style>
        html,
        body {
            height: auto;
            min-height: 100%;
            margin: 0;
            overflow: hidden;
            overflow-y: auto;
        }
    </style>
</h:head>

<h:body>
    <ui:include src="header.xhtml" />
    <h:form id="adminForm" enctype="multipart/form-data">
        <h:panelGroup layout="block" rendered="#{sessionBean.admin}">
            <div class="admin-dashboard">
                <main class="admin-content">
                    <header class="content-header d-flex justify-content-between align-items-center">
                        <h2 class="welcome-title">Вітаємо, Адміністратор!</h2>
                        <div class="admin-badge">Admin Mode</div>
                    </header>

                    <div id="prod_mng" class="admin-card shadow-sm">
                        <div class="admin-grid-container">
                            <aside class="admin-actions-sidebar">
                                <div class="actions-menu">
                                    <button type="button" class="action-btn active"
                                        onclick="openAction(event, 'createProd')">Додати товар
                                    </button>

                                    <button type="button" class="action-btn"
                                        onclick="openAction(event, 'updateProd')">Редагувати
                                    </button>

                                    <button type="button" class="action-btn"
                                        onclick="openAction(event, 'removeProd')">Видалити товар
                                    </button>
                                </div>
                            </aside>
                            <section class="admin-main-panel">
                                <h:panelGroup id="create_prod" styleClass="action-form-content js-admin-content active">
                                    <h4 class="mb-4 text-purple " style="padding: 10px 0px;">Новий товар</h4>
                                    <div class="row g-3">
                                        <div class="col-md-12">
                                            <label class="form-label">Назва для відображення</label>
                                            <h:inputText styleClass="custom-input"
                                                value="#{adminBean.newProduct.name}" />
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Італійська назва</label>
                                            <h:inputText styleClass="custom-input"
                                                value="#{adminBean.newProduct.italianName}" />
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Українська назва</label>
                                            <h:inputText styleClass="custom-input"
                                                value="#{adminBean.newProduct.ukrainianName}" />
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Опис (description)</label>
                                            <h:inputTextarea styleClass="custom-input" rows="2"
                                                value="#{adminBean.newProduct.description}" />
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Категорія</label>
                                            <h:selectOneMenu styleClass="custom-input"
                                                value="#{adminBean.newProduct.type}">
                                                <f:selectItems value="#{adminBean.productTypes}" var="type"
                                                    itemValue="#{type}" itemLabel="#{type.toString()}" />
                                            </h:selectOneMenu>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Поточна ціна</label>
                                            <h:inputText styleClass="custom-input" value="#{adminBean.newProduct.price}"
                                                p:placeholder="0.0" p:required="true"
                                                requiredMessage="Введіть Поточна ціна" />
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Стара ціна</label>
                                            <h:inputText styleClass="custom-input"
                                                value="#{adminBean.newProduct.oldPrice}" p:placeholder="0.0"
                                                p:required="true" requiredMessage="Введіть Стара ціна" />
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Склад</label>
                                            <h:inputText styleClass="custom-input" value="#{adminBean.newProduct.stock}"
                                                p:placeholder="0" p:required="true" requiredMessage="Введіть Склад" />
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Акцентний колір</label>
                                            <h:inputText styleClass="custom-input"
                                                value="#{adminBean.newProduct.accentColor}" />
                                        </div>
                                        <div class="col-md-8">
                                            <label class="form-label">Стиль градієнта</label>
                                            <h:inputText styleClass="custom-input"
                                                value="#{adminBean.newProduct.gradientStyle}" />
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Зображення</label>
                                            <h:inputFile value="#{adminBean.uploadedFile}"
                                                styleClass="form-control custom-file-input" />
                                        </div>
                                        <div class="col-12 mt-4">
                                            <h:commandButton value="Зберегти в каталозі"
                                                action="#{adminBean.createProduct}" styleClass="main-admin-btn">
                                                <f:ajax execute="@form" render="@form flash-messages"
                                                    onevent="handleAjaxEvents" />
                                            </h:commandButton>
                                        </div>
                                    </div>
                                </h:panelGroup>
                                <h:panelGroup id="update_prod" styleClass="action-form-content js-admin-content">
                                    <div class="d-flex justify-content-between align-items-center mb-4">
                                        <h4 class="text-purple m-0" style="padding: 10px 0px;">Редагувати товар</h4>
                                        <button type="button" class="btn-delete-main"
                                            style="background-color: var(--dark-blue);"
                                            onclick="toggleProductSelector(true)">
                                            <i class="bi bi-search"></i> Вибрати товар для редагування
                                        </button>
                                    </div>
                                    <h:panelGroup id="update_form_fields" layout="block" styleClass="row g-3"
                                        style="#{adminBean.editingProduct.productId gt 0 ? '' : 'pointer-events: none; opacity: 0.5;'}">
                                        <div class="col-md-3">
                                            <label class="form-label">Id </label>
                                            <h:inputText styleClass="custom-input"
                                                value="#{adminBean.editingProduct.productId}" readonly="true"
                                                disabled="true" />
                                        </div>
                                        <div class="col-md-9"></div>
                                        <div class="col-md-12">
                                            <div class="d-flex align-items-center mb-2">
                                                <label class="login-checkbox">
                                                    <h:selectBooleanCheckbox value="#{adminBean.updateName}">
                                                        <f:ajax render="nameInput" />
                                                    </h:selectBooleanCheckbox>
                                                    <span class="login-checkmark"></span>
                                                </label>
                                                <label class="form-label m-0">Назва для відображення</label>
                                            </div>
                                            <h:inputText id="nameInput" styleClass="custom-input"
                                                value="#{adminBean.editingProduct.name}"
                                                disabled="#{!adminBean.updateName}" />
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center mb-2">
                                                <label class="login-checkbox">
                                                    <h:selectBooleanCheckbox value="#{adminBean.updateItalianName}">
                                                        <f:ajax render="itNameInput" />
                                                    </h:selectBooleanCheckbox>
                                                    <span class="login-checkmark"></span>
                                                </label>
                                                <label class="form-label m-0">Італійська назва</label>
                                            </div>
                                            <h:inputText id="itNameInput" styleClass="custom-input"
                                                value="#{adminBean.editingProduct.italianName}"
                                                disabled="#{!adminBean.updateItalianName}" />
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center mb-2">
                                                <label class="login-checkbox">
                                                    <h:selectBooleanCheckbox value="#{adminBean.updateUkrainianName}">
                                                        <f:ajax render="uaNameInput" />
                                                    </h:selectBooleanCheckbox>
                                                    <span class="login-checkmark"></span>
                                                </label>
                                                <label class="form-label m-0">Українська назва</label>
                                            </div>
                                            <h:inputText id="uaNameInput" styleClass="custom-input"
                                                value="#{adminBean.editingProduct.ukrainianName}"
                                                disabled="#{!adminBean.updateUkrainianName}" />
                                        </div>
                                        <div class="col-12">
                                            <div class="d-flex align-items-center mb-2">
                                                <label class="login-checkbox">
                                                    <h:selectBooleanCheckbox value="#{adminBean.updateDescription}">
                                                        <f:ajax render="descriptionInput" />
                                                    </h:selectBooleanCheckbox>
                                                    <span class="login-checkmark"></span>
                                                </label>
                                                <label class="form-label m-0">Опис (description)</label>
                                            </div>
                                            <h:inputTextarea id="descriptionInput" styleClass="custom-input" rows="2"
                                                value="#{adminBean.editingProduct.description}"
                                                disabled="#{!adminBean.updateDescription}" />
                                        </div>
                                        <div class="col-md-4">
                                            <div class="d-flex align-items-center mb-2">
                                                <label class="login-checkbox">
                                                    <h:selectBooleanCheckbox value="#{adminBean.updateType}">
                                                        <f:ajax render="typeInput" />
                                                    </h:selectBooleanCheckbox>
                                                    <span class="login-checkmark"></span>
                                                </label>
                                                <label class="form-label m-0">Категорія</label>
                                            </div>
                                            <h:selectOneMenu id="typeInput" styleClass="custom-input"
                                                value="#{adminBean.editingProduct.type}"
                                                disabled="#{!adminBean.updateType}">
                                                <f:selectItems value="#{adminBean.productTypes}" var="type"
                                                    itemValue="#{type}" itemLabel="#{type.toString()}" />
                                            </h:selectOneMenu>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="d-flex align-items-center mb-2">
                                                <label class="login-checkbox">
                                                    <h:selectBooleanCheckbox value="#{adminBean.updatePrice}">
                                                        <f:ajax render="priceInput" />
                                                    </h:selectBooleanCheckbox>
                                                    <span class="login-checkmark"></span>
                                                </label>
                                                <label class="form-label m-0">Поточна ціна</label>
                                            </div>
                                            <h:inputText id="priceInput" styleClass="custom-input" p:placeholder="0.0"
                                                value="#{adminBean.editingProduct.price}"
                                                disabled="#{!adminBean.updatePrice}" />
                                        </div>
                                        <div class="col-md-3">
                                            <div class="d-flex align-items-center mb-2">
                                                <label class="login-checkbox">
                                                    <h:selectBooleanCheckbox value="#{adminBean.updateOldPrice}">
                                                        <f:ajax render="oldPriceInput" />
                                                    </h:selectBooleanCheckbox>
                                                    <span class="login-checkmark"></span>
                                                </label>
                                                <label class="form-label m-0">Стара ціна</label>
                                            </div>
                                            <h:inputText id="oldPriceInput" styleClass="custom-input"
                                                p:placeholder="0.0" value="#{adminBean.editingProduct.oldPrice}"
                                                disabled="#{!adminBean.updateOldPrice}" />
                                        </div>
                                        <div class="col-md-2">
                                            <div class="d-flex align-items-center mb-2">
                                                <label class="login-checkbox">
                                                    <h:selectBooleanCheckbox value="#{adminBean.updateStock}">
                                                        <f:ajax render="stockInput" />
                                                    </h:selectBooleanCheckbox>
                                                    <span class="login-checkmark"></span>
                                                </label>
                                                <label class="form-label m-0">Склад</label>
                                            </div>
                                            <h:inputText id="stockInput" styleClass="custom-input"
                                                value="#{adminBean.editingProduct.stock}"
                                                disabled="#{!adminBean.updateStock}" />
                                        </div>
                                        <div class="col-md-4">
                                            <div class="d-flex align-items-center mb-2">
                                                <label class="login-checkbox">
                                                    <h:selectBooleanCheckbox value="#{adminBean.updateAccentColor}">
                                                        <f:ajax render="accentColorInput" />
                                                    </h:selectBooleanCheckbox>
                                                    <span class="login-checkmark"></span>
                                                </label>
                                                <label class="form-label m-0">Акцентний колір</label>
                                            </div>
                                            <h:inputText id="accentColorInput" styleClass="custom-input"
                                                value="#{adminBean.editingProduct.accentColor}"
                                                disabled="#{!adminBean.updateAccentColor}" />
                                        </div>
                                        <div class="col-md-8">
                                            <div class="d-flex align-items-center mb-2">
                                                <label class="login-checkbox">
                                                    <h:selectBooleanCheckbox value="#{adminBean.updateGradientStyle}">
                                                        <f:ajax render="gradientStyleInput" />
                                                    </h:selectBooleanCheckbox>
                                                    <span class="login-checkmark"></span>
                                                </label>
                                                <label class="form-label m-0">Стиль градієнта</label>
                                            </div>
                                            <h:inputText id="gradientStyleInput" styleClass="custom-input"
                                                value="#{adminBean.editingProduct.gradientStyle}"
                                                disabled="#{!adminBean.updateGradientStyle}" />
                                        </div>
                                        <div class="col-12">
                                            <div class="d-flex align-items-center mb-2 ">
                                                <label class="login-checkbox">
                                                    <h:selectBooleanCheckbox value="#{adminBean.updateImagePath}">
                                                        <f:ajax render="filePathInput" />
                                                    </h:selectBooleanCheckbox>
                                                    <span class="login-checkmark"></span>
                                                </label>
                                                <label class="form-label m-0">Нове зображення </label>
                                            </div>
                                            <h:inputFile id="filePathInput" value="#{adminBean.editUploadedFile}"
                                                styleClass="form-control custom-file-input"
                                                disabled="#{!adminBean.updateImagePath}" />
                                        </div>
                                        <div class="col-12 mt-4">
                                            <h:commandButton value="Оновити дані в каталозі"
                                                action="#{adminBean.updateProduct}" styleClass="main-admin-btn">
                                                <f:ajax execute="update_form_fields"
                                                    render="update_form_fields messages productTableGroup selection_table_group flash-messages"
                                                    onevent="onUpdateComplete" />
                                            </h:commandButton>
                                        </div>
                                    </h:panelGroup>
                                    <div id="product_selector_overlay" class="selector-overlay">
                                        <div class="admin-card shadow-lg p-4" style="width: 100%; max-height: 90vh;">
                                            <div class="d-flex justify-content-between align-items-center mb-4">
                                                <h4 class="text-purple m-0">Виберіть товар</h4>
                                                <div class="d-flex gap-2">
                                                    <h:inputHidden id="tempEditId"
                                                        value="#{adminBean.selectedEditProductId}" />
                                                    <h:commandButton id="confirmSelectionBtn" value="Вибрати"
                                                        styleClass="btn-delete-main opacity-50"
                                                        style="pointer-events: none;">
                                                        <f:ajax execute="@this tempEditId"
                                                            listener="#{adminBean.loadProductToEdit}"
                                                            render="update_form_fields flash-messages"
                                                            onevent="onProductSelected" />
                                                    </h:commandButton>
                                                    <button type="button" class="btn-delete-main"
                                                        style="background-color: #666;"
                                                        onclick="toggleProductSelector(false)">Скасувати
                                                    </button>
                                                </div>
                                            </div>
                                            <h:panelGroup id="selection_table_group"
                                                styleClass="table-scroll-container">
                                                <table class="table admin-table align-middle m-0" id="selection_table">
                                                    <thead>
                                                        <tr>
                                                            <th>ID</th>
                                                            <th>Фото</th>
                                                            <th>Назва</th>
                                                            <th>Ціна</th>
                                                            <th>Категорія</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <ui:repeat value="#{adminBean.allProducts}" var="prod">
                                                            <tr onclick="selectForEdit(#{prod.productId}, this)"
                                                                style="cursor:pointer">
                                                                <td>##{prod.productId}</td>
                                                                <td><img src="#{request.contextPath}/#{prod.imagePath}"
                                                                        class="table-img" /></td>
                                                                <td class="prod-name-cell">#{prod.italianName}</td>
                                                                <td>#{prod.price} ₴</td>
                                                                <td>#{prod.type}</td>
                                                            </tr>
                                                        </ui:repeat>
                                                    </tbody>
                                                </table>
                                            </h:panelGroup>
                                        </div>
                                    </div>
                                </h:panelGroup>

                                <h:panelGroup id="remove_prod" styleClass="action-form-content js-admin-content">
                                    <div class="d-flex justify-content-between align-items-center mb-4 flex-shrink-0">
                                        <h4 class="text-purple m-0" style="padding: 10px 0px;">Список товарів</h4>
                                        <h:inputHidden id="selectedProdId" value="#{adminBean.selectedProductId}" />
                                        <h:commandButton id="realDeleteBtn" action="#{adminBean.deleteSelectedProduct}"
                                            style="display:none">
                                            <f:ajax execute="selectedProdId"
                                                render="productTableGroup selection_table_group flash-messages"
                                                onevent="onDeleteComplete" />
                                        </h:commandButton>
                                        <button type="button" class="btn-delete-main" id="mainDeleteBtn"
                                            disabled="disabled" onclick="triggerDelete()">
                                            <i class="bi bi-trash"></i> Видалити вибране
                                        </button>
                                    </div>
                                    <h:panelGroup id="productTableGroup" styleClass="table-scroll-container">
                                        <table class="table admin-table align-middle m-0">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Фото</th>
                                                    <th>Назва</th>
                                                    <th>Ціна</th>
                                                    <th>Категорія</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <ui:repeat value="#{adminBean.allProducts}" var="prod">
                                                    <tr data-id="#{prod.productId}">
                                                        <td>##{prod.productId}</td>
                                                        <td><img src="#{request.contextPath}/#{prod.imagePath}"
                                                                class="table-img" /></td>
                                                        <td>#{prod.italianName}</td>
                                                        <td>#{prod.price} ₴</td>
                                                        <td>#{prod.type}</td>
                                                    </tr>
                                                </ui:repeat>
                                            </tbody>
                                        </table>
                                    </h:panelGroup>
                                </h:panelGroup>
                            </section>
                        </div>
                    </div>
                </main>
            </div>
        </h:panelGroup>

        <h:panelGroup layout="block" rendered="#{!sessionBean.admin}">
            <div class="container mt-5 pt-5 text-center">
                <div class="admin-card p-5 shadow-sm border-0 " style="align-items: center;">
                    <i class="bi bi-shield-lock text-danger" style="font-size: 4rem;"></i>
                    <h2 class="text-purple mt-3">Доступ заборонено</h2>
                    <p class="text-muted mb-4">У вас немає прав для перегляду цієї сторінки.</p>
                    <h:link outcome="login" value="Авторизуватись як адмін"
                        styleClass="main-admin-btn d-inline-block text-decoration-none"
                        style="max-width: 300px; padding: 10px 30px;" />
                </div>
            </div>
        </h:panelGroup>
    </h:form>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleProductSelector(show) {
            const overlay = $('[id$="product_selector_overlay"]');
            if (show) {
                overlay.css('display', 'flex').hide().fadeIn(200);
            } else {
                overlay.fadeOut(200);
            }
        }

        function onProductSelected(data) {
            if (data.status === 'begin') {
            }
            if (data.status === 'success') {
                toggleProductSelector(false);
                const fields = $('[id$="update_form_fields"]');
                fields.css({
                    'opacity': '1',
                    'pointer-events': 'auto'
                });
                const confirmBtn = $('[id$="confirmSelectionBtn"]');
                confirmBtn.addClass('opacity-50').css('pointer-events', 'none');
                if (typeof initToasts === "function") initToasts();
            }
        }

        function onDeleteComplete(data) {
            if (data.status === 'success') {
                $('#mainDeleteBtn').prop('disabled', true);
                $('[id$="selectedProdId"]').val("");
                $('.selected-row').removeClass('selected-row');
                if (typeof initToasts === "function") initToasts();
            }
        }
        function onUpdateComplete(data) {
            if (data.status === 'success') {
                const fields = $('[id$="update_form_fields"]');

                fields.css({
                    'opacity': '0.5',
                    'pointer-events': 'none'
                });

                if (typeof initToasts === "function") initToasts();
            }
        }

        function openAction(evt, actionName) {
            if (evt) evt.preventDefault();

            $('.action-btn').removeClass('active');
            $(evt.currentTarget).addClass('active');

            $('.action-form-content').removeClass('active');
            let suffix = "";
            if (actionName === 'createProd') suffix = "create_prod";
            else if (actionName === 'updateProd') suffix = "update_prod";
            else if (actionName === 'removeProd') suffix = "remove_prod";

            const target = $("[id$='" + suffix + "']");
            if (target.length) {
                target.addClass('active');
            }

            $('.selected-row').removeClass('selected-row');
            $('#mainDeleteBtn').prop('disabled', true);

            $('[id$="selectedProdId"]').val("");
            $('[id$="tempEditId"]').val("");
        }

        function selectForEdit(id, element) {
            $('#selection_table tr').removeClass('selected-row');
            $(element).addClass('selected-row');

            const hiddenInput = $('[id$="tempEditId"]');
            hiddenInput.val(id);

            const confirmBtn = $('[id$="confirmSelectionBtn"]');
            confirmBtn.removeClass('opacity-50').css('pointer-events', 'auto');
        }

        function triggerDelete() {
            if (confirm('Видалити вибраний товар?')) {
                const btn = document.querySelector('[id$="realDeleteBtn"]');
                if (btn) btn.click();
            }
        }

        $(document).ready(function () {
            $('.action-form-content').removeClass('active');
            const firstTab = $("[id$='create_prod']");
            if (firstTab.length) {
                firstTab.addClass('active');
                $('.action-btn').first().addClass('active');
            }
            $(document).on('click', '.admin-table:not(#selection_table) tbody tr', function () {
                const productId = $(this).data('id') || $(this).find('td:first').text().replace('#', '');
                const hiddenInput = $('[id$="selectedProdId"]');

                if ($(this).hasClass('selected-row')) {
                    $(this).removeClass('selected-row');
                    hiddenInput.val("");
                    $('#mainDeleteBtn').prop('disabled', true);
                } else {
                    $('.admin-table:not(#selection_table) tbody tr').removeClass('selected-row');
                    $(this).addClass('selected-row');
                    hiddenInput.val(productId);
                    $('#mainDeleteBtn').prop('disabled', false);
                }
            });
            $('#selection_table').on('click', 'tbody tr', function () {
            });
        });
    </script>
</h:body>

</html>