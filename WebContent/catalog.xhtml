<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:p="http://xmlns.jcp.org/jsf/passthrough">

<h:head>
    <title>IceCreamy | Catalog</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
    <link href="#{request.contextPath}/css/nouislider.min.css" rel="stylesheet" />
    <link href="#{request.contextPath}/css/mycustom.css" rel="stylesheet" />
</h:head>
<h:body>
    <ui:include src="header.xhtml" />
    <h:form id="mainForm">
        <h:inputHidden id="minPrice" value="#{customerBean.minPrice}" />
        <h:inputHidden id="maxPrice" value="#{customerBean.maxPrice}" />
        <h:commandButton id="priceTrigger" action="#{customerBean.searchByPriceRange()}" style="display:none">
            <f:ajax execute="@form" render="productsGrid filterBadge activeSortLabel" />
        </h:commandButton>

        <div class="catalog-page ">
            <div class="container">
                <div class="options-sticky-bar shadow-sm-bottom">
                    <div class="row align-items-center">
                        <div class="col-6 col-md-4">
                            <div class="dropdown" id="filter-dropdown-container">
                                <button id="filter-toggle-main"
                                    class="filter-btn d-flex align-items-center px-3 py-2 shadow-sm w-100" type="button"
                                    data-bs-toggle="dropdown" data-bs-auto-close="outside">
                                    <div class="sort-icon me-2 flex-shrink-0 d-flex align-items-center justify-content-center"
                                        style="width: 24px; height: 24px;">
                                        <i class="bi bi-sliders main-icon-style"></i>
                                    </div>
                                    <div class="filter-text-container d-flex align-items-center">
                                        <span class="fs-6 fw-medium d-none d-sm-inline me-1">Фільтри:</span>
                                        <h:panelGroup id="filterBadge">
                                            <span class="badge-count">#{customerBean.tempFiltersCount}</span>
                                        </h:panelGroup>
                                        <h:panelGroup id="resultsCount"><span
                                                class="fs-6 fw-medium mx-1 d-none d-md-inline">знайдено</span><span
                                                class="fs-6 fw-medium">#{customerBean.products.size()}</span>
                                        </h:panelGroup>
                                    </div>
                                </button>
                                <div class="dropdown-menu custom-filter-panel border-0 shadow-lg">
                                    <div class="filter-header-overlay px-3 py-2" onclick="hideFilterDropdown()">
                                        <div class="sort-icon me-2 flex-shrink-0 d-flex align-items-center justify-content-center"
                                            style="width: 24px; height: 24px; ">
                                            <i class="bi bi-arrow-left main-icon-style"></i>
                                        </div>
                                        <div class="filter-text-container d-flex align-items-center">
                                            <span class="fs-6 fw-medium d-none d-sm-inline me-1">Фільтри:</span>
                                            <h:panelGroup id="filterBadgeOverlay">
                                                <span class="badge-count">#{customerBean.tempFiltersCount}</span>
                                            </h:panelGroup>
                                            <span class="fs-6 fw-medium mx-1 d-none d-md-inline">знайдено</span>
                                            <span class="fs-6 fw-medium">#{customerBean.products.size()}</span>
                                        </div>
                                    </div>
                                    <hr class="filter-divider m-0">
                                    </hr>
                                    <div class="filter-section">
                                        <div class="px-3 pt-3 d-flex justify-content-between align-items-center">
                                            <span class="fs-5 fw-medium text-purple">Ціна</span>
                                        </div>
                                        <div class="p-3">
                                            <div class="d-flex align-items-center justify-content-between mb-3">
                                                <span class="text-purple fw-medium">від</span>
                                                <h:inputText id="temp-min" value="#{customerBean.tempMinPrice}"
                                                    styleClass="price-input-field" p:type="number" p:min="0" />
                                                <span class="text-purple fw-medium">до</span>
                                                <h:inputText id="temp-max" value="#{customerBean.tempMaxPrice}"
                                                    styleClass="price-input-field" p:type="number" p:min="0" />
                                                <span class="text-purple fw-medium">₴</span>
                                            </div>
                                            <div id="price_slider_container" class="px-2 mt-4 mb-4">
                                                <div id="price_slider" class="pl-2"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <hr class="filter-divider m-0">
                                    </hr>
                                    <div class="filter-section">
                                        <div class="px-3 pt-3 pb-2 d-flex justify-content-between align-items-center">
                                            <span class="fs-5 fw-medium text-purple">Вид</span>
                                        </div>
                                        <div class="px-3 pb-3">
                                            <ui:repeat
                                                value="#{['WAFFLE_CONE', 'ICE_CREAM_SANDWICH', 'POPSICLE', 'PAPER_CUP', 'PACKAGED_ICE_CREAM']}"
                                                var="type">
                                                <label class="custom-checkbox d-flex align-items-center mb-2">
                                                    #{customerBean.getProductTypeLabel(type)}
                                                    <h:selectBooleanCheckbox
                                                        value="#{customerBean.tempTypeSelections[type]}">
                                                        <f:ajax render="mainForm:filterBadge" />
                                                    </h:selectBooleanCheckbox>
                                                    <span class="checkmark"></span>
                                                </label>
                                            </ui:repeat>
                                        </div>
                                    </div>
                                    <hr class="filter-divider m-0">
                                    </hr>
                                    <div class="d-flex gap-2 p-3">
                                        <h:commandButton value="Скинути" action="#{customerBean.resetFilters()}"
                                            styleClass="filter-action-btn">
                                            <f:ajax render="@form" onevent="handleAjaxEvents" />
                                        </h:commandButton>
                                        <h:commandButton value="Застосувати" action="#{customerBean.commitFilters()}"
                                            styleClass="filter-action-btn apply-active">
                                            <f:ajax execute="@form"
                                                render="mainForm:productsGrid mainForm:filterBadge mainForm:resultsCount"
                                                onevent="handleApplyFilters" />
                                        </h:commandButton>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-sm-auto ms-auto text-end">
                            <div class="dropdown" id="sort-dropdown-main">
                                <button class="sort-btn d-flex align-items-center shadow-sm dropdown-toggle"
                                    type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <div class="sort-icon me-2 flex-shrink-0 d-flex align-items-center justify-content-center"
                                        style="width: 24px; height: 24px;">
                                        <i class="bi bi-chevron-expand main-icon-style"></i>
                                    </div>
                                    <h:panelGroup id="activeSortLabel" layout="block" styleClass="sort-text-container">
                                        <span class="fw-medium text-purple d-none d-md-inline me-1">Сортування:</span>
                                        <span class="fw-medium text-purple active-sort-label">
                                            #{customerBean.sortState == 1 ? 'За зростанням ціни' :
                                            (customerBean.sortState == 2 ? 'За спаданням ціни' : 'Нічого')}
                                        </span>
                                    </h:panelGroup>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end custom-sort-menu border-0 shadow-lg">
                                    <li>
                                        <hr class="dropdown-divider" />
                                    </li>
                                    <li>
                                        <h:commandLink action="#{customerBean.setSortState(0)}"
                                            styleClass="dropdown-item py-1 #{customerBean.sortState == 0 ? 'active' : ''}">
                                            Нічого
                                            <f:ajax render="mainForm:productsGrid mainForm:activeSortLabel" />
                                        </h:commandLink>
                                    </li>
                                    <li>
                                        <hr class="dropdown-divider" />
                                    </li>
                                    <li>
                                        <h:commandLink action="#{customerBean.setSortState(1)}"
                                            styleClass="dropdown-item py-1 #{customerBean.sortState == 1 ? 'active' : ''}">
                                            За зростанням ціни
                                            <f:ajax render="mainForm:productsGrid mainForm:activeSortLabel" />
                                        </h:commandLink>
                                    </li>
                                    <li>
                                        <hr class="dropdown-divider" />
                                    </li>
                                    <li>
                                        <h:commandLink action="#{customerBean.setSortState(2)}"
                                            styleClass="dropdown-item py-1 #{customerBean.sortState == 2 ? 'active' : ''}">
                                            За спаданням ціни
                                            <f:ajax render="mainForm:productsGrid mainForm:activeSortLabel" />
                                        </h:commandLink>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 py-2">
                    <h:panelGroup id="productsGrid" layout="block" styleClass="row g-4">
                        <ui:repeat value="#{customerBean.products}" var="product">
                            <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                                <div class="product-card shadow-sm border-0 position-relative">
                                    <h:link outcome="product" styleClass="stretched-link">
                                        <f:param name="id" value="#{product.productId}" />
                                    </h:link>
                                    <div class="product-img-wrap">
                                        <h:graphicImage value="/#{product.imagePath}" alt="#{product.name}" />
                                    </div>
                                    <div class="product-info bg-white d-flex flex-column">
                                        <h5 class="product-title fw-medium">
                                            #{product.name}
                                        </h5>
                                        <div class="price-cart-row mt-auto">
                                            <div class="price-block">
                                                <ui:fragment rendered="#{product.oldPrice > 0}">
                                                    <span
                                                        class="old-price me-2 text-decoration-line-through text-accent opacity-70">
                                                        #{product.oldPrice}
                                                    </span>
                                                </ui:fragment>
                                                <span class="current-price fw-bold text-accent">#{product.price}
                                                    ₴</span>
                                            </div>
                                            <div class="cart-action-wrapper" style="position: relative; z-index: 2;">
                                                <h:panelGroup
                                                    rendered="#{customerBean.getQuantityInCart(product.productId) == 0}">
                                                    <h:commandLink styleClass="btn-add-to-cart border-0 bg-transparent">
                                                        <f:ajax listener="#{customerBean.addToCart(product.productId)}"
                                                            execute="@this"
                                                            render="@form :cartBadgeGroup :flash-messages"
                                                            onevent="onAddToCartAjax" />
                                                        <i class="bi bi-cart text-accent"></i>
                                                    </h:commandLink>
                                                </h:panelGroup>
                                                <h:panelGroup
                                                    rendered="#{customerBean.getQuantityInCart(product.productId) > 0}">
                                                    <div class="cart-controls rounded-pill px-2 d-flex">
                                                        <h:commandLink styleClass="qty-btn" value="-"
                                                            style="text-decoration: none;">
                                                            <f:ajax
                                                                listener="#{customerBean.updateQuantity(product.productId, -1)}"
                                                                render="@form :cartBadgeGroup" />
                                                        </h:commandLink>
                                                        <span
                                                            class="qty-val px-1">#{customerBean.getQuantityInCart(product.productId)}</span>
                                                        <h:commandLink styleClass="qty-btn" value="+"
                                                            style="text-decoration: none;">
                                                            <f:ajax
                                                                listener="#{customerBean.updateQuantity(product.productId, 1)}"
                                                                render="@form :cartBadgeGroup" />
                                                        </h:commandLink>
                                                    </div>
                                                </h:panelGroup>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </ui:repeat>
                    </h:panelGroup>
                </div>
            </div>
        </div>
        <ui:include src="footer.xhtml" />
    </h:form>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="#{request.contextPath}/js/nouislider.min.js"></script>

    <script>
        $(document).on('click', '.custom-filter-panel', function (e) {
            e.stopPropagation();
        });

        function hideFilterDropdown() {
            const dropdownToggle = document.getElementById('filter-toggle-main');
            const dropdownInstance = bootstrap.Dropdown.getOrCreateInstance(dropdownToggle);
            if (dropdownInstance) dropdownInstance.hide();
        }

        function initPriceSlider() {
            var sliderElem = document.getElementById('price_slider');
            var tempMinInput = document.querySelector('[id$="temp-min"]');
            var tempMaxInput = document.querySelector('[id$="temp-max"]');

            if (sliderElem &amp;&amp; tempMinInput &amp;&amp; tempMaxInput) {
                if (sliderElem.noUiSlider) {
                    sliderElem.noUiSlider.destroy();
                }

                noUiSlider.create(sliderElem, {
                    start: [parseInt(tempMinInput.value) || 0, parseInt(tempMaxInput.value) || 200],
                    connect: true,
                    step: 1,
                    range: { 'min': 0, 'max': 200 },
                    format: {
                        to: function (value) { return Math.round(value); },
                        from: function (value) { return value; }
                    }
                });

                sliderElem.noUiSlider.on('update', function (values, handle) {
                    if (handle) {
                        tempMaxInput.value = values[handle];
                    } else {
                        tempMinInput.value = values[handle];
                    }
                });

                sliderElem.noUiSlider.on('change', function (values) {
                    tempMinInput.value = Math.round(values[0]);
                    tempMaxInput.value = Math.round(values[1]);

                    tempMinInput.dispatchEvent(new Event('change'));
                    tempMaxInput.dispatchEvent(new Event('change'));

                });
            }
        }

        function handleAjaxEvents(data) {
            if (data.status === 'success') {
                initPriceSlider();
            }
        }

        function handleApplyFilters(data) {
            if (data.status === 'success') {
                hideFilterDropdown();
                initPriceSlider();
            }
        }

        $(document).ready(function () {
            initPriceSlider();
        });
        function onAddToCartAjax(data) {
            if (data.status === 'success') {
                if (typeof initToasts === 'function') initToasts();
            }
        }
        $(document).ready(function () {
            $(document).on('click', '.btn-add-to-cart', function (e) {
                let $btn = $(this);
                let $wrapper = $btn.closest('.cart-action-wrapper');
                let $controls = $wrapper.find('.cart-controls');

                $btn.addClass('d-none');
                $controls.removeClass('d-none').addClass('d-flex');
            });
            $(document).on('click', '.btn-plus', function () {
                let $val = $(this).siblings('.qty-val');
                $val.text(parseInt($val.text()) + 1);
            });

            $(document).on('click', '.btn-minus', function () {
                let $val = $(this).siblings('.qty-val');
                let current = parseInt($val.text());
                if (current > 1) {
                    $val.text(current - 1);
                } else {
                    let $wrapper = $(this).closest('.cart-action-wrapper');
                    $wrapper.find('.cart-controls').removeClass('d-flex').addClass('d-none');
                    $wrapper.find('.btn-add-to-cart').removeClass('d-none');
                }
            });
        });
    </script>
</h:body>

</html>